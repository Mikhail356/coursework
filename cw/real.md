# Реализация макета децентрализованной системы
В данном разделе приводится подробное описание работы системы и набора используемых технологий. Это нужно для создания физического объекта, на котором будут проверяться математические выводы получнные на модели предыдущего раздела. Также бывает полезным для построения таких выводов явно представлять себе в голове всю структуру системы. Перейдем к описанию основных рабочих объектов.
## Определения
1. Страница ученого - html страница содержащая информацию о ученом, его соавторах и публикациях.
2. Страница публикации - html страница содержащая информацию о публикации и ее авторах.
3. Сервер - сервер, которым владеет определенное научное учреждение. На нем содержатся страницы ученых и их публикаций.
4. Источник (source) - страница ученого/публикации с которой отправляют web интернет запросы.
5. Цель (target) - страница ученого/публикации на которую поступают web интернет запросы.
4. WebMention сервер - специальный сервер, который получает и записывает в базу данных запросы от серверов_ в определенном формате: URL адрес source источника, URL адрес target цели, URL адрес WebMention сервера. Отличается своей структурой от сервера, но также является собственностью соответствующего серверу научного учреждения.
6. База Данных (БД) - хранит записи в формате: URL адрес source источника, URL адрес target цели, время поступления запроса на WebMention сервер, URL адрес WebMention сервера. Является собственностью соответствующего серверу и WebMention серверу научного учреждения.

## Команды работы с проектом
Чтобы дать физическое оформление способам связи из предыдущего раздела в проекте используется язык программирования python3. Здесь кратко описывается поведение этого кода. В работе проекта используется всего две команды это команда обновления и проверки информации в базе данных веб-запросов пользователя. Такой малый набор команд связан с его логической простотой и легкостью в использовании.
### Команда обновления (update)
Начать стоит с описания поведения команды обновления. На вход ей подается URL адрес страницы. Команда отпраляет все ссылки в ней на WebMention сервер, который записывает их в соответствующем формате в БД. Используется перед удалением страницы или после изменения содержимого страницы, не затрагивающего ссылки. Дадим более детальное с технической точки зрения описание. Алгоритм работы:
1. Отправить GET запрос на указанный URL адрес
2. Если ответ пришел без ошибок (с кодом 200), то перейти к следующему шагу. Иначе прекратить работу и вывести сообщение об ошибке.
3. Разобрать html код страницы, полученный на прошлом шаге.
4. Найти все ссылки на другие страницы и URL адрес WebMention сервера.
5. Отправить на URL адрес WebMention сервера POST запросы, содержащие:
    1. URL Адрес личного  WebMention сервера для сервера, содержащего текущую страницу.
    1. URL Адрес текущей страницы.
    1. URL Адрес целевой страницы.
6. Вывод URL адресов обновленных страниц на экран.

### Команда проверки (check)
Приступим к формальному описанию следующей команды, а именно проверки. На вход ей подается физический адрес .html файла страницы и ее URL адрес. Команда скачивает из БД свои запросы, появившиеся после последней проверки, и редактирует существующую страницу в соответствии с ними. Редактирование происходит путем добавления и удаления новых ученых, публикаций, ссылок. Используется после изменения ссылок внутри страницы. Перейдем к формальному описанию выполнения команды. Алгоритм работы:
1. Считать из отдельного файла (с именем time) время последнего обновления страницы.
2. Разобрать .html страницу на теги. 
3. Найти в разборе URL адрес WebMention сервера.
4. Считать из БД все записи, посланные на данный WebMention сервер, имеющие целью текущую страницу, и появившиеся после даты последней проверки.
5. Отправить GET запросы на все WebMention сервера с целью на страницы, запросы которых содержали целью текущую страницу.
6. Если результат запроса оказался удовлетворительным (вернулся с кодом 200) перейти к следующему пункту, иначе поместить обрабатываемую страницу в список адресов страниц на удаление (с именем remove).
7. Провести проверку страницы на подлинность, в случае успеха перейти к следующему шагу, иначе поместить данную страницу в список адресов страниц на удаление (с именем remove).
8. URL адрес страницы поместить в массив адресов страниц для добавления (с именем add).
9. Найти в разборе текущей страницы все ссылки на другие страницы и поместить в массив current.
10. Если среди последних есть адреса страниц подлежащих удалению (находятся в remove), то сделать соответствующие виртуальные изменения в коде страницы.
11. Если в current нет каких-то URL адресов из массива add, то сделать соответствующие виртуальные изменения в коде страницы.
12. Вывести на экран список изменений страницы и запросить пользователя разрешение на их внесение в физический код страницы.
13. В случае отказа, завершить работу команды. Иначе провести изменения кода страницы.
14. Записать в файл time время последнего обновления данной страницы.
15. Вызвать команду update, описанную выше.

## Работа с microformats2
Для работы вышеописанных алгоритмов нужно описать как именно строится страница и какие используются имена классов в microformats2 формате. Пример разметки страницы с ее использованием дает общее рпедставление об этом.
``` html 
<!DOCTYPE HTML>
<html>
  <head>
   <meta http-equiv="content-type" content="text/html" charset="utf-8">
   <title>Кривчиков Максим Александрович</title>
   <link rel="webmention" href="http://127.0.0.1:1234" />
  </head>
  <body>
    <div class="h-card">
      <a class="p-name">Кривчиков Максим Александрович</a>
      <p>
      <a class="p-honorific-suffix">Кандидат ф.-м. наук</a>,
      <a class="p-role">доцент кафедры вычислительной математики</a>.
      </p>
    </div>
   </body>
</html>
```
Ее разбор в json файле будет выглядеть так
``` json 
{
    "items": [
        {
            "type": [
                "h-card"
            ],
            "properties": {
                "name": [
                    "Кривчиков Максим Александрович"
                ],
                "honorific-suffix": [
                    "Кандидат ф.-м. наук"
                ],
                "role": [
                    "доцент кафедры вычислительной математики"
                ]
            }
        }
    ],
    "rels": {
        "webmention": [
            "http://127.0.0.1:1234"
        ]
    },
    "rel-urls": {
        "http://127.0.0.1:1234": {
            "text": "",
            "rels": [
                "webmention"
            ]
        }
    },
    "debug": {
        "description": "mf2py - microformats2 parser for python",
        "source": "https://github.com/microformats/mf2py",
        "version": "1.1.2",
        "markup parser": "html5lib"
    }
}
```
Видно что использован специальный микроформат h-card и его аргументы p-name, p-honorific-suffux, p-role для разметки информации. Примечательно, что все дочерние теги могут иметь любые имена после определенной приставки, как и описано в обзоре технологий построения распределенных веб-систем. Также в более сложных страницах для описания соавторов, публикаций и авторов публикаций используются имена h-istina-coauthors, h-istina-article-journal, h-istina-authors соответственно.
## Запуск макета
В подтверждение реализации всех описанных выше алгоритмов и использования описанных технологий представляется разумным дать описание запуска и работы с уже существующим проектом. Найти его можно в GitHub репозитории [5]. Для его запуска нужно выполнить несколько несложных команд:
1. Скачать и установить все необходимые python библиотеки : mf2py, mf2util, json, sys, requests, aiosqlite, sqlite3, bs4, а также версию python не ниже 3.
2. Запустить команду start.sh (создает сервера при помощи darkhttpd), находится в папке serv.
3. Запустить при помощи команды python3 webmention-logger.py WebMention сервер.

После этих команд запустится несколько локальных серверов которые будут раздавать документы из соответствующих им папок. Так, например, содержимое папки serv/1 будет доступно по пути http://127.0.0.1:8081/ с добавлением соответствующего названия файла.

На момент написания данной работы макет обрабатывает только 2 ситуации:
1. Пользователь решил обновить ссылки определенной страницы (например serv/1/index.html) в базе данных, тогда нужно ввести команду python3 update.py http://127.0.0.1:8081/index.html. 
2. Пользователь хочет проверить действительны ли еще ссылки текущей страницы (serv/1/index.html) и нужно ли их дополнить новыми. Тогда нужно ввести команду python3 check.py serv/1/index.html http://127.0.0.1:8081/index.html. В ходе работы нужно будет подтвердить или отвергнуть изменения текущей страницы.
